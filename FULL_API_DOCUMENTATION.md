# Traceability Tag Print API – Full Documentation

## Table of Contents

1. [Architecture Overview](#1-architecture-overview)
2. [Barcode Generation Process](#2-barcode-generation-process)
3. [API Endpoints – Traceability Flow](#3-api-endpoints--traceability-flow)
4. [API Endpoints – Printing](#4-api-endpoints--printing)
5. [API Endpoints – Registration](#5-api-endpoints--registration)
6. [Database Tables Reference](#6-database-tables-reference)
7. [Stored Procedures Reference](#7-stored-procedures-reference)
8. [Complete User Workflow](#8-complete-user-workflow)

---

## 1. Architecture Overview

```
┌────────────────┐     ┌──────────────────┐     ┌──────────────┐     ┌──────────────────┐
│  Frontend /    │────▶│   FastAPI Routes  │────▶│   Services   │────▶│   Repositories   │
│  Desktop App   │◀────│  (traceability_   │◀────│  (business   │◀────│  (DB calls /     │
│                │     │   route, print_   │     │   logic)     │     │   SP execution)  │
│                │     │   route, register)│     │              │     │                  │
└────────────────┘     └──────────────────┘     └──────────────┘     └──────────┬───────┘
                                                                                │
                                                                     ┌──────────▼───────┐
                                                                     │  SQL Server DB   │
                                                                     │  (DTraceProddb)  │
                                                                     │                  │
                                                                     │  Stored Procs:   │
                                                                     │  PRC_PrintKanban │
                                                                     │  PRC_UserSupplier│
                                                                     │  _EndUser        │
                                                                     │  PRC_GetRunning  │
                                                                     │  SerialReset     │
                                                                     └──────────────────┘
```

### Layer Mapping

| Layer | File | Purpose |
|-------|------|---------|
| Route | `traceability_route.py` | Login, model selection, lock/unlock |
| Route | `print_route.py` | Print, reprint, get image |
| Route | `register.py` | User/supervisor registration |
| Service | `traceability_service.py` | Auth logic, model list, lock state |
| Service | `print_service.py` | Parse SP result, supervisor auth for reprint |
| Repo | `traceability_repo.py` | Direct SP calls for login/model/lock |
| Repo | `print_repo.py` | Direct SP calls for print/reprint/image |
| Repo | `register_repo.py` | Direct SP calls for user CRUD |

---

## 2. Barcode Generation Process

### How the Barcode is Generated (Inside SP `PRC_PrintKanban`)

The barcode is **NOT generated by the API**. It is generated **entirely inside the SQL Server stored procedure** `PRC_PrintKanban` when `@Type = 'KANBAN_PRINT'` or `'KANBAN_RE_PRINT'`.

#### Step-by-Step Flow:

```
┌──────────────────────────────────────────────────────────────────────┐
│                    BARCODE GENERATION FLOW                          │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  1. API receives print request with:                                 │
│     PartNo, SupplierCode, LotNo1, LotNo2, Qty                      │
│           │                                                          │
│           ▼                                                          │
│  2. SP determines SHIFT                                              │
│     → Calls dbo.GetShiftTime(GETDATE(), @SupplierCode)              │
│     → Result: 'A', 'B', or 'C'                                      │
│           │                                                          │
│           ▼                                                          │
│  3. SP generates RUNNING SERIAL NUMBER                               │
│     → Calls PRC_GetRunningSerialReset                                │
│       ('KANBAN_PRINT', @LotNo1, @LastShift, @SupplierCode, OUTPUT)  │
│     → Increments SerialNo in TBL_RunningSerialNo                    │
│     → Pads to 7 digits: RIGHT('0000000' + CAST(serial), 7)         │
│     → Result: '0000001', '0000002', etc.                            │
│           │                                                          │
│           ▼                                                          │
│  4. SP builds BARCODE STRING                                         │
│     → Format: PARTNO|QTY|SUPPLIERCODE|LOTNO|SERIALNO                │
│     → Example: DNHA001|72|SUP001|LOT20260222001|0000001             │
│     → Converted to UPPER CASE                                       │
│           │                                                          │
│           ▼                                                          │
│  5. SP inserts into TT_Kanban_Print table                           │
│           │                                                          │
│           ▼                                                          │
│  6. SP returns RESULT as tilde-delimited string                     │
│     → Y~SupplierName~Traceability Tag~0000001~DNSO~NEW~...         │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

#### Barcode Format

**Single Lot (LotNo2 is empty):**
```
PARTNO | SUPPLIER_PART_LOT_SIZE | SUPPLIER_CODE | LOT_NO_1 | SERIAL_NO
```
Example: `DNHA001|72|SUP001|LOT20260222001|0000001`

**Mixed Lot (LotNo2 is provided):**

Two barcodes are generated:
```
Barcode Lot 1: PARTNO | QTY           | SUPPLIER_CODE | LOT_NO_1 | SERIAL_NO_1
Barcode Lot 2: PARTNO | (LOTSIZE-QTY) | SUPPLIER_CODE | LOT_NO_2 | SERIAL_NO_2
```
Example:
- Lot1: `DNHA001|36|SUP001|MIXLOT1|0000001`
- Lot2: `DNHA001|36|SUP001|MIXLOT2|0000002`

Each part of the barcode:

| Position | Field | Source | Description |
|----------|-------|--------|-------------|
| 1 | PartNo | `@PartNo` parameter | DENSO part number (e.g., `DNHA001`) |
| 2 | Qty/LotSize | `@SupplierPartLotSize` or `@Qty` | Pack size from `TM_DnhaPart_And_SupplierPart_Mapping.SupplierPartLotSize` |
| 3 | SupplierCode | `@SupplierCode` parameter | Supplier code (e.g., `SUP001`) |
| 4 | LotNo | `@LotNo1` / `@LotNo2` parameter | Lot number entered by operator |
| 5 | SerialNo | Generated by SP | 7-digit running serial from `TBL_RunningSerialNo` |

#### Serial Number Generation (`PRC_GetRunningSerialReset`)

```sql
-- Checks if a serial entry exists for this supplier
IF EXISTS(SELECT 1 FROM TBL_RunningSerialNo 
          WHERE TranType='KANBAN_PRINT' AND SupplierCode=@SupplierCode 
          AND SerialNo < 9999999)
BEGIN
    -- INCREMENT existing serial
    UPDATE TBL_RunningSerialNo
    SET SerialNo = SerialNo + 1, UpdateDate = GETDATE()
    WHERE TranType='KANBAN_PRINT' AND SupplierCode=@SupplierCode
END
ELSE
BEGIN
    -- INSERT new serial starting at 1
    INSERT INTO TBL_RunningSerialNo (TranType, SerialNo, UpdateDate, SupplierCode)
    VALUES ('KANBAN_PRINT', 1, GETDATE(), @SupplierCode)
END
```

The serial **resets after 9999999** (starts over at 1).
The serial is **per SupplierCode** (each supplier has its own sequence).

#### SP Result String Format

The SP returns a tilde (`~`) delimited string:

```
Y~SupplierName~Traceability Tag~SerialNo~CompanyName~TagType~PrintDate~BarcodeLot1~BarcodeLot2~SerialNo2~PrintTime~CountTags~TotalTags
```

| Index | Field | Example |
|-------|-------|---------|
| 0 | Status | `Y` (success) |
| 1 | Supplier Name | `ABC Auto Parts Ltd` |
| 2 | Traceability | `Traceability Tag` |
| 3 | Serial No | `0000001` |
| 4 | Company Name | `DNSO` |
| 5 | Tag Type | `NEW` |
| 6 | Print Date | `22/02/2026 15:00` |
| 7 | Barcode Lot 1 | `DNHA001\|72\|SUP001\|LOT001\|0000001` |
| 8 | Barcode Lot 2 | (empty if single lot) |
| 9 | Serial No 2 | (empty if single lot) |
| 10 | Print Time | `15:00:00` |
| 11 | Count Tags | `1` (distinct bin barcodes) |
| 12 | Total Tags | `72` (count × lot size) |

---

## 3. API Endpoints – Traceability Flow

### 3.1 POST `/api/traceability/login`

| Item | Detail |
|------|--------|
| **Purpose** | App login for EOL User / Supervisor |
| **SP** | `PRC_PrintKanban` → inline SQL (no SP TYPE, direct query) |
| **Tables READ** | `TM_Supplier_End_User`, `TM_Supplier_GROUP`, `TM_Supplier_GROUP_RIGHTS`, `TM_Supplier_UserMaster`, `TM_Supplier_Plant` |
| **Tables WRITE** | None |
| **Auth** | None (this IS the auth endpoint) |

**Request:**
```json
{
  "user_id": "admin01",
  "password": "admin@123"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Login successful",
  "data": {
    "user_id": "admin01",
    "user_name": "Admin User",
    "supplier_code": "SUP001",
    "supplier_plant_code": "PLT01",
    "packing_station": "STN01",
    "plant_name": "Noida_group",
    "group_id": 1,
    "group_name": "EOL User"
  }
}
```

**Flow:**
```
Login → TM_Supplier_UserMaster (IsSupplier check)
      → TM_Supplier_End_User (password check)
      → TM_Supplier_GROUP (group lookup)
      → TM_Supplier_GROUP_RIGHTS (screen rights check: 3001, 2003)
      → TM_Supplier_Plant (plant name lookup)
```

---

### 3.2 POST `/api/traceability/traceability-user`

| Item | Detail |
|------|--------|
| **Purpose** | Auto-fill Plant, Line, Shift on Traceability Tag screen |
| **SP** | Inline SQL (replaces `@Type = 'VALIDATEUSER'`) |
| **Tables READ** | `TM_Supplier_End_User`, `TM_Supplier_GROUP`, `TM_Supplier_GROUP_RIGHTS`, `TM_Supplier_Plant` |
| **Tables WRITE** | None |

**Request:**
```json
{
  "user_id": "admin01",
  "password": "admin@123"
}
```

**Response:** User details with `PackingStation` (= station_no for the UI's "Line" field).

---

### 3.3 POST `/api/traceability/supervisor-login`

| Item | Detail |
|------|--------|
| **Purpose** | Authenticate supervisor for Model Change |
| **SP** | Inline SQL (replaces `@Type = 'VALIDATE_DEVICE_SUPERVISOR'`) |
| **Tables READ** | `TM_Supplier_End_User`, `TM_Supplier_GROUP`, `TM_Supplier_GROUP_RIGHTS` (ScreenId `3002`, `2003`), `TM_Supplier_Plant` |
| **Tables WRITE** | None |

**Request:**
```json
{
  "user_id": "supervisor01",
  "password": "pass@123"
}
```

---

### 3.4 POST `/api/traceability/model-list`

| Item | Detail |
|------|--------|
| **Purpose** | Get supplier parts for Model Change dropdown |
| **SP** | `PRC_PrintKanban @Type = 'GET_SUPPLIERPART'` |
| **Tables READ** | `TM_DnhaPart_And_SupplierPart_Mapping`, `TM_Supplier_Station_Part_Mapping`, `TM_DensoPart_And_SupplierCode_Mapping`, `TM_SuppUser_SuppCode_Mapping`, `TM_Supplier_End_User`, `TM_SuppCustPart_And_SuppPart_Mapping`, `TM_Supplier_Customer`, `TT_LevelUp` |
| **Tables WRITE** | None |
| **SP Parameters** | `@StationNo`, `@PlantCode`, `@PrintedBy` |

**Request:**
```json
{
  "station_no": "STN01",
  "plant_code": "PLT01",
  "printed_by": "admin01"
}
```

**Response:**
```json
{
  "success": true,
  "data": [
    { "supplier_part": "SP-PART-01", "supplier_name": "SP-PART-01" },
    { "supplier_part": "SP-PART-02", "supplier_name": "SP-PART-02" }
  ]
}
```

**Table Join Flow:**
```
TM_DnhaPart_And_SupplierPart_Mapping (SupplierPart)
  ├── JOIN TM_Supplier_Station_Part_Mapping (filter by Station, PlantCode)
  ├── JOIN TM_DensoPart_And_SupplierCode_Mapping (supplier access check)
  └── JOIN TM_SuppUser_SuppCode_Mapping (user-supplier mapping)

UNION

TM_SuppCustPart_And_SuppPart_Mapping (for other-customer parts)
  ├── JOIN TM_Supplier_Station_Part_Mapping
  ├── JOIN TM_Supplier_Customer
  └── JOIN TM_Supplier_End_User (SupplierCode split check)
```

---

### 3.5 POST `/api/traceability/confirm-model`

| Item | Detail |
|------|--------|
| **Purpose** | Auto-fill ALL fields after model selection |
| **SP** | `PRC_PrintKanban @Type = 'GET_PRINT_PARAMETER'` |
| **Tables READ** | `TM_DnhaPart_And_SupplierPart_Mapping`, `TM_Item_Master_A`, `TM_Item_Master_B`, `TM_Supplier_Lot_Structure`, `TM_SuppCustPart_And_SuppPart_Mapping`, `TM_SUPPLIER_CUTOMER_PART`, `TM_Supplier_Customer`, `TT_LevelUp` |
| **Tables WRITE** | None |
| **SP Parameters** | `@SupplierPartNo`, `@SupplierCode`, `@PlantCode`, `@StationNo` |

**Request:**
```json
{
  "supplier_part_no": "SP-PART-01",
  "supplier_code": "SUP001",
  "plant_code": "PLT01",
  "station_no": "STN01"
}
```

**Response includes:**
- `part_no`, `part_name` – from `TM_Item_Master_A`
- `lot_size`, `bin_qty` – from `TM_Item_Master_B.LOTSZ`
- `supplier_part_lot_size`, `supplier_part_weight`, `tolerance_weight` – from `TM_DnhaPart_And_SupplierPart_Mapping`
- `total_no_of_digits`, `no_of_steps`, `step_X_digits`, `step_X_scan_type` – from `TM_Supplier_Lot_Structure`
- `lot_lock_type` – from `TM_Supplier_Lot_Structure` (`Enable`/`Disable`/`STANDARD`)
- `weighing_scale`, `bin_weight`, `bin_tolerance_weight` – from mapping table

**Table Join Flow:**
```
TM_DnhaPart_And_SupplierPart_Mapping
  ├── JOIN TM_Item_Master_A (PartNo, PartName)
  ├── JOIN TM_Item_Master_B (LotSize/LOTSZ)
  └── JOIN TM_Supplier_Lot_Structure (lot structure, scan types, lock type)
        ↕ Joined on BOTH SupplierCode AND SupplierPart
```

---

### 3.6 POST `/api/traceability/lock-fields`

| Item | Detail |
|------|--------|
| **Purpose** | Lock form fields (read-only) |
| **SP** | None (direct query to `TM_Supplier_Lot_Structure`) |
| **Tables READ** | `TM_Supplier_Lot_Structure` (reads `LotLockType`) |
| **Tables WRITE** | None (lock state is in-memory) |

**Request:**
```json
{
  "supplier_part_no": "SP-PART-01",
  "supplier_code": "SUP001",
  "plant_code": "PLT01",
  "station_no": "STN01"
}
```

**Logic:**
```
1. Query TM_Supplier_Lot_Structure WHERE SupplierPart = @supplier_part_no
2. Read LotLockType:
   - "Enable"   → Allow lock, return locked=true
   - "STANDARD" → Allow lock, return locked=true
   - "Disable"  → Reject lock, return locked=false
   - NULL       → Part not found, return error
3. Store lock state in memory (keyed by part+supplier+plant+station)
```

---

### 3.7 POST `/api/traceability/unlock-fields`

| Item | Detail |
|------|--------|
| **Purpose** | Unlock form fields (requires supervisor auth) |
| **SP** | Inline SQL for supervisor validation (same as supervisor-login) |
| **Tables READ** | `TM_Supplier_End_User`, `TM_Supplier_GROUP`, `TM_Supplier_GROUP_RIGHTS`, `TM_Supplier_Plant` |
| **Tables WRITE** | None (lock state is in-memory) |

**Request:**
```json
{
  "user_id": "supervisor01",
  "password": "pass@123",
  "supplier_part_no": "SP-PART-01",
  "supplier_code": "SUP001",
  "plant_code": "PLT01",
  "station_no": "STN01"
}
```

---

## 4. API Endpoints – Printing

### 4.1 POST `/api/printing/print`

| Item | Detail |
|------|--------|
| **Purpose** | Print a new traceability tag (QR barcode) |
| **SP** | `PRC_PrintKanban @Type = 'KANBAN_PRINT'` |
| **Sub-SP** | `PRC_GetRunningSerialReset` (serial number generation) |
| **Tables READ** | `TM_Supplier_Customer`, `tbShiftMaster`, `TM_DnhaPart_And_SupplierPart_Mapping`, `TM_SuppCustPart_And_SuppPart_Mapping`, `TM_SUPPLIER_MASTER`, `TM_Company` |
| **Tables WRITE** | `TT_Kanban_Print` (INSERT), `TBL_RunningSerialNo` (UPDATE serial) |
| **SP Parameters** | `@CompanyCode`, `@PlantCode`, `@StationNo`, `@SupplierCode`, `@CustomerCode`, `@SupplierPartNo`, `@PartNo`, `@LotNo1`, `@LotNo2`, `@TagType`, `@Weight`, `@Qty`, `@IsMixedLot`, `@RunningSNNo`, `@RM_Material`, `@PrintedBy`, `@OldBarcode`, `@Grossweight` |

**Request:**
```json
{
  "plant_code": "PLT01",
  "station_no": "STN01",
  "supplier_code": "SUP001",
  "supplier_part_no": "SP-PART-01",
  "part_no": "DNHA001",
  "lot_no_1": "LOT20260222001",
  "weight": 9216.0,
  "qty": 72,
  "printed_by": "admin01",
  "company_code": "DNSO",
  "customer_code": "CUST01",
  "lot_no_2": "",
  "is_mixed_lot": false,
  "gross_weight": "9500"
}
```

**Response:**
```json
{
  "success": true,
  "message": "QR Tag Printed Successfully!",
  "data": {
    "supplier_name": "ABC Auto Parts Ltd",
    "traceability": "Traceability Tag",
    "serial_no": "0000001",
    "company_name": "DNSO",
    "tag_type": "NEW",
    "print_date": "22/02/2026 23:07",
    "barcode_lot1": "DNHA001|72|SUP001|LOT20260222001|0000001",
    "barcode_lot2": null,
    "serial_no_2": null,
    "print_time": "23:07:15",
    "no_of_tags_stock_in": 1,
    "total_qty_stock_in": 72
  }
}
```

**Internal SP Flow:**
```
KANBAN_PRINT
  │
  ├── 1. Get last shift from tbShiftMaster
  │
  ├── 2. Determine current shift via dbo.GetShiftTime()
  │      (checks TM_Supplier_Customer for other-customer suppliers)
  │
  ├── 3. Get SupplierPartLotSize from TM_DnhaPart_And_SupplierPart_Mapping
  │      UNION TM_SuppCustPart_And_SuppPart_Mapping
  │
  ├── 4. IF mixed lot (LotNo2 is not empty):
  │      ├── Calculate: Lot1Qty = LotSize - Qty
  │      ├── Generate SerialNo1 via PRC_GetRunningSerialReset
  │      ├── Generate SerialNo2 via PRC_GetRunningSerialReset
  │      ├── Build Barcode1: PARTNO|QTY|SUPPLIERCODE|LOTNO1|SERIAL1
  │      └── Build Barcode2: PARTNO|LOT1QTY|SUPPLIERCODE|LOTNO2|SERIAL2
  │
  ├── 5. ELSE single lot:
  │      ├── Generate SerialNo via PRC_GetRunningSerialReset
  │      └── Build Barcode: PARTNO|LOTSIZE|SUPPLIERCODE|LOTNO1|SERIAL
  │
  ├── 6. Get SupplierName from TM_SUPPLIER_MASTER or TM_Supplier_Customer
  │
  ├── 7. INSERT into TT_Kanban_Print
  │      (CompanyCode, PrintType='Fresh', PlantCode, Shift, SupplierCode,
  │       CustomerCode, SupplierPartNo, PartNo, Status=1, LotNo1, LotNo2,
  │       TagType='NEW', Weight, Qty, IsMixedLot, RunningSNNo, RM_Material,
  │       StationNo, Barcode, PrintedBy, PrintedOn=GETDATE(), PackSize,
  │       Grossweight, WeighingScale, BinBarcode, BinQty)
  │
  ├── 8. Count tags: COUNT(DISTINCT BinBarcode) WHERE SupplierPartNo AND Status=1
  │
  └── 9. Return tilde-delimited Result + 'QR Tag Printed Successfully!' Msg
```

---

### 4.2 POST `/api/printing/reprint`

| Item | Detail |
|------|--------|
| **Purpose** | Re-print tag (replace old barcode with new) |
| **SP** | `PRC_PrintKanban @Type = 'KANBAN_RE_PRINT'` |
| **Sub-SP** | `PRC_GetRunningSerialReset` |
| **Pre-check** | Supervisor authentication via `VALIDATE_DEVICE_SUPERVISOR` |
| **Tables READ** | Same as KANBAN_PRINT + `TT_Kanban_Print` (read old barcode) |
| **Tables WRITE** | `TT_Kanban_Re_Print_History` (INSERT old record), `TT_Kanban_Print` (DELETE old, INSERT new, UPDATE bin barcodes), `TBL_RunningSerialNo` (UPDATE serial) |

**Request:**
```json
{
  "supervisor_user_id": "supervisor01",
  "supervisor_password": "pass@123",
  "plant_code": "PLT01",
  "station_no": "STN01",
  "supplier_code": "SUP001",
  "supplier_part_no": "SP-PART-01",
  "part_no": "DNHA001",
  "lot_no_1": "LOT20260222001",
  "weight": 9216.0,
  "qty": 72,
  "printed_by": "admin01",
  "old_barcode": "DNHA001|72|SUP001|LOT20260222001|0000001"
}
```

**Internal SP Flow:**
```
KANBAN_RE_PRINT
  │
  ├── 1. [API LAYER] Validate supervisor credentials
  │
  ├── 2. Generate new serial & barcode (same as KANBAN_PRINT)
  │
  ├── 3. INSERT old record into TT_Kanban_Re_Print_History
  │      (copies from TT_Kanban_Print WHERE Barcode = @OldBarcode)
  │
  ├── 4. Save BinBarcode & BinQty from old record
  │
  ├── 5. DELETE old record from TT_Kanban_Print
  │      WHERE Barcode = @OldBarcode AND DispatchStatus = 0
  │
  ├── 6. INSERT new record into TT_Kanban_Print
  │      (with new barcode, new serial, PrintType='Fresh')
  │
  ├── 7. UPDATE all linked records:
  │      UPDATE TT_Kanban_Print SET BinBarcode = @NewBarcode
  │      WHERE BinBarcode = @OldBinBarcode
  │
  └── 8. Return result (same format as KANBAN_PRINT)
```

---

### 4.3 GET `/api/printing/image/{supplier_part}`

| Item | Detail |
|------|--------|
| **Purpose** | Get supplier part image (binary JPEG) |
| **SP** | `PRC_PrintKanban @Type = 'GET_PRINT_IMAGE'` |
| **Tables READ** | `TM_DnhaPart_And_SupplierPart_Mapping` (column `SupplierPartImage`) |
| **Tables WRITE** | None |

**Request:** `GET /api/printing/image/SP-PART-01`

**Response:** Raw image bytes (`Content-Type: image/jpeg`) or 404 if no image.

**SP Logic:**
```sql
SELECT SupplierPartImage 
FROM TM_DnhaPart_And_SupplierPart_Mapping 
WHERE SupplierPart = @SupplierPartNo
```

---

## 5. API Endpoints – Registration

All registration endpoints use SP: `PRC_UserSupplier_EndUser`

### 5.1 POST `/api/register/user`

| Item | Detail |
|------|--------|
| **SP** | `PRC_UserSupplier_EndUser @Type = 'INSERT'` |
| **Tables WRITE** | `TM_Supplier_End_User` |

### 5.2 POST `/api/register/supervisor`

| Item | Detail |
|------|--------|
| **SP** | `PRC_UserSupplier_EndUser @Type = 'INSERT'` (different group_id) |
| **Tables WRITE** | `TM_Supplier_End_User` |

### 5.3 POST `/api/register/change-password`

| Item | Detail |
|------|--------|
| **SP** | `PRC_UserSupplier_EndUser @Type = 'UPDATEPASSWORD'` |
| **Tables WRITE** | `TM_Supplier_End_User` |

### 5.4 PUT `/api/register/{user_id}`

| Item | Detail |
|------|--------|
| **SP** | `PRC_UserSupplier_EndUser @Type = 'UPDATE'` |
| **Tables WRITE** | `TM_Supplier_End_User` |

### 5.5 DELETE `/api/register/{user_id}`

| Item | Detail |
|------|--------|
| **SP** | `PRC_UserSupplier_EndUser @Type = 'DELETE'` |
| **Tables WRITE** | `TM_Supplier_End_User` |

### 5.6 GET `/api/register/list`

| Item | Detail |
|------|--------|
| **SP** | `PRC_UserSupplier_EndUser @Type = 'SELECT'` |
| **Tables READ** | `TM_Supplier_End_User` |

### 5.7 GET `/api/register/groups`

| Item | Detail |
|------|--------|
| **SP** | `PRC_UserSupplier_EndUser @Type = 'SELECT_GROUP'` |
| **Tables READ** | `TM_Supplier_GROUP` |

### 5.8 GET `/api/register/plants`

| Item | Detail |
|------|--------|
| **SP** | `PRC_UserSupplier_EndUser @Type = 'Get_Plant'` |
| **Tables READ** | `TM_Supplier_Plant` |

### 5.9 GET `/api/register/stations`

| Item | Detail |
|------|--------|
| **SP** | `PRC_UserSupplier_EndUser @Type = 'Get_Packing_Station'` |
| **Tables READ** | `TM_Supplier_Station_Part_Mapping` |

---

## 6. Database Tables Reference

### Core Tables

| Table | Purpose | Used By |
|-------|---------|---------|
| `TM_Supplier_End_User` | End users & supervisors | Login, Register, Auth |
| `TM_Supplier_GROUP` | User groups (EOL User, Supervisor, TL) | Login, Auth |
| `TM_Supplier_GROUP_RIGHTS` | Screen-level permissions per group | Login, Supervisor Auth |
| `TM_Supplier_UserMaster` | Admin/supplier users (IsSupplier='Y') | Login (path 1) |
| `TM_Supplier_Plant` | Plant codes & names | Login, Register |

### Part & Mapping Tables

| Table | Purpose | Used By |
|-------|---------|---------|
| `TM_DnhaPart_And_SupplierPart_Mapping` | Maps SupplierPart ↔ DENSO Part + images | Model List, Confirm Model, Print, Image |
| `TM_SuppCustPart_And_SuppPart_Mapping` | Maps SupplierPart for other-customer parts | Model List, Confirm Model, Print |
| `TM_Item_Master_A` | Part numbers & descriptions (ITNBR, ITDSC) | Confirm Model |
| `TM_Item_Master_B` | Part lot sizes (LOTSZ) | Confirm Model |
| `TM_Supplier_Lot_Structure` | Lot config: steps, digits, scan types, **LotLockType** | Confirm Model, Lock Fields |
| `TM_Supplier_Station_Part_Mapping` | Which parts are at which station | Model List |
| `TM_DensoPart_And_SupplierCode_Mapping` | DENSO part ↔ supplier code mapping | Model List |
| `TM_SuppUser_SuppCode_Mapping` | User ↔ supplier code mapping | Model List |
| `TM_Supplier_Customer` | Other-customer supplier config | Print, Shift |
| `TM_SUPPLIER_CUTOMER_PART` | Customer-supplier part details | Print details |
| `TM_SUPPLIER_MASTER` | Supplier master (VNDNR, VNAME) | Print (supplier name) |
| `TM_Company` | Company master (abbreviation) | Print (company name) |

### Transaction Tables

| Table | Purpose | Used By |
|-------|---------|---------|
| `TT_Kanban_Print` | **Main print transaction table** – every printed tag | Print, Re-Print, Print Details |
| `TT_Kanban_Re_Print_History` | History of re-printed tags (old barcode → new) | Re-Print |
| `TBL_RunningSerialNo` | Running serial counter per supplier (auto-increment) | Print, Re-Print |
| `TBL_RunningSerial` | Running serial with lot/shift tracking | (used by other SP types) |
| `TT_LevelUp` | Level-up part mapping (old → new part) | Model List, Confirm Model |

### Config Tables

| Table | Purpose | Used By |
|-------|---------|---------|
| `tbShiftMaster` | Shift definitions (A/B/C, times) per supplier | Print (shift detection) |
| `TM_Print_Prn` | Printer configuration (PRN, IP, Port) | PRINT_PRN type |

---

## 7. Stored Procedures Reference

### `PRC_PrintKanban` – Main SP

| @Type | Purpose | API Endpoint |
|-------|---------|-------------|
| `GET_SUPPLIERPART` | Get supplier parts for dropdown | `/api/traceability/model-list` |
| `GET_PRINT_PARAMETER` | Get full part details for auto-fill | `/api/traceability/confirm-model` |
| `GET_PRINT_IMAGE` | Get supplier part image (binary) | `/api/printing/image/{part}` |
| `GET_SHIFT` | Get current shift (A/B/C) | Used internally during print |
| `GET_PRINT_DETAILS` | Get last 3 print records | Not yet exposed as API |
| `GET_ALL_PRINT_DETAILS` | Get all undispatched prints | Not yet exposed as API |
| `GET_LAST_PRINT_DETAILS` | Get last serial + tag counts | Not yet exposed as API |
| `KANBAN_PRINT` | Print new tag (generates barcode) | `/api/printing/print` |
| `KANBAN_RE_PRINT` | Re-print tag (replace barcode) | `/api/printing/reprint` |
| `KANBAN_REWORK_RE_PRINT` | Re-print rework tag | Not yet exposed as API |
| `GET_ALL_REWORK_PRINT_DETAILS` | Get all rework prints | Not yet exposed as API |
| `GET_REPRINT_PARAMETER` | Get lot structure for re-print | Not yet exposed as API |
| `PRINT_PRN` | Save printer config | Not yet exposed as API |

### `PRC_GetRunningSerialReset` – Serial Number Generator

| Parameter | Type | Purpose |
|-----------|------|---------|
| `@TrnType` | VARCHAR(50) | Always `'KANBAN_PRINT'` |
| `@LotNo` | VARCHAR(50) | Lot number (not used in serial logic) |
| `@Shift` | VARCHAR(20) | Current shift (not used in serial logic) |
| `@SupplierCode` | VARCHAR(20) | **Key:** serial is per-supplier |
| `@SERIAL_NO` | OUTPUT | Returns the new serial number |

### `PRC_UserSupplier_EndUser` – User Management SP

| @Type | Purpose | API Endpoint |
|-------|---------|-------------|
| `INSERT` | Register new user | `/api/register/user`, `/api/register/supervisor` |
| `UPDATE` | Update user | `PUT /api/register/{user_id}` |
| `DELETE` | Delete user | `DELETE /api/register/{user_id}` |
| `SELECT` | List users | `GET /api/register/list` |
| `UPDATEPASSWORD` | Change password | `/api/register/change-password` |
| `SELECT_GROUP` | Get groups | `GET /api/register/groups` |
| `Get_Plant` | Get plants | `GET /api/register/plants` |
| `Get_Packing_Station` | Get stations | `GET /api/register/stations` |

---

## 8. Complete User Workflow

```
┌─────────────────────────────────────────────────────────────────┐
│                     COMPLETE USER WORKFLOW                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ① LOGIN                                                         │
│  POST /api/traceability/login                                    │
│  → Gets: user_id, supplier_code, plant_code, packing_station    │
│                                                                   │
│  ② OPEN TRACEABILITY TAG SCREEN                                  │
│  POST /api/traceability/traceability-user                        │
│  → Auto-fills: Plant, Line (PackingStation), Shift               │
│                                                                   │
│  ③ MODEL CHANGE (if needed)                                      │
│  POST /api/traceability/supervisor-login                         │
│  → Supervisor authenticates                                      │
│                                                                   │
│  ④ SELECT MODEL                                                  │
│  POST /api/traceability/model-list                               │
│  → Gets dropdown list of supplier parts                          │
│                                                                   │
│  ⑤ CONFIRM MODEL                                                 │
│  POST /api/traceability/confirm-model                            │
│  → Auto-fills: Customer Part No, Part Name, Batch Size, Weight,  │
│    Supplier Part No, Lot Structure config, LotLockType           │
│                                                                   │
│  ⑥ LOCK FIELDS (optional)                                        │
│  POST /api/traceability/lock-fields                              │
│  → Makes fields read-only (if LotLockType != 'Disable')         │
│                                                                   │
│  ⑦ ENTER LOT NUMBERS                                             │
│  → User manually types Lot No. 1 (and optionally Lot No. 2)     │
│  → User enters Weight on scale                                   │
│                                                                   │
│  ⑧ PRINT TAG                                                     │
│  POST /api/printing/print                                        │
│  → SP generates serial number + barcode                          │
│  → Inserts into TT_Kanban_Print                                  │
│  → Returns barcode string for QR code generation                 │
│                                                                   │
│  ⑨ RE-PRINT (if needed)                                          │
│  POST /api/printing/reprint                                      │
│  → Requires supervisor auth + old barcode                        │
│  → Old record → history, new barcode generated                   │
│                                                                   │
│  ⑩ VIEW IMAGE                                                    │
│  GET /api/printing/image/{supplier_part}                         │
│  → Returns JPEG image of the part                                │
│                                                                   │
│  ⑪ UNLOCK (if locked)                                            │
│  POST /api/traceability/unlock-fields                            │
│  → Supervisor auth required to unlock                            │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

### Mapping: UI Fields → API → SP → DB

| UI Field (Screenshot) | Filled By | API | SP/Table |
|----------------------|-----------|-----|----------|
| Plant (Gr. Noida) | Auto-fill on login | `/traceability-user` | `TM_Supplier_Plant.PlantName` |
| Line (Station-1) | Auto-fill on login | `/traceability-user` | `TM_Supplier_End_User.PackingStation` |
| Shift (B) | Auto-fill on model confirm | `dbo.GetShiftTime()` | `tbShiftMaster` |
| Customer Part No. | Auto-fill on model select | `/confirm-model` | `TM_Item_Master_A.ITNBR` |
| Part Name | Auto-fill on model select | `/confirm-model` | `TM_Item_Master_A.ITDSC` |
| Supplier Part No. | Auto-fill on model select | `/confirm-model` | `TM_DnhaPart_And_SupplierPart_Mapping.SupplierPart` |
| Batch Size | Auto-fill on model select | `/confirm-model` | `TM_Item_Master_B.LOTSZ` |
| Weight (g) | User enters / weighing scale | — | Passed to `@Weight` in print |
| Lot No. 1 | **User enters manually** | — | Passed to `@LotNo1` in print |
| Lot No. 2 | **User enters manually** | — | Passed to `@LotNo2` in print |
| Last Tag Serial | After print | `/printing/print` response | `TBL_RunningSerialNo.SerialNo` |
| No. of Tag Stock In | After print | `/printing/print` response | `COUNT(DISTINCT BinBarcode)` from `TT_Kanban_Print` |
| Total Qty. Stock In | After print | `/printing/print` response | Count × LotSize |
| Last Printed Tag | After print | `/printing/print` response | Barcode string |
| Printed grid (bottom) | History | Not yet exposed | `TT_Kanban_Print` records |
